<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/car-battery.png">
    <title>PROPART SYSTEM ML - FERNANDO MILL√ÅN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto+Mono:wght@400;500&display=swap');
        
        :root { --brand: #2563eb; --dark: #020617; }
        
        body { background-color: #000; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .app-header { background: linear-gradient(180deg, #0f172a 0%, #020617 100%); border-bottom: 2px solid var(--brand); box-shadow: 0 4px 15px rgba(37,99,235,0.2); }
        .btn-main { background: #0f172a; border: 1px solid #1e293b; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-main:active { transform: scale(0.96); border-color: var(--brand); background: #1e1b4b; }
        .card { background: #0a0a0a; border: 1px solid #1f2937; border-left: 4px solid #3b82f6; padding: 10px; margin-bottom: 6px; border-radius: 4px; }
        .console { background: #000; border: 1px solid #333; height: 150px; overflow-y: auto; padding: 8px; font-family: 'Roboto Mono', monospace; font-size: 10px; color: #22c55e; box-shadow: inset 0 0 10px #000; }
        input, select { background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; width: 100%; outline: none; text-transform: uppercase; font-weight: bold; }
        input:focus, select:focus { border-color: var(--brand); }
        .admin-view { display: none; }
        .show-admin .admin-view { display: flex; }
        .hidden { display: none !important; }
        .no-scroll::-webkit-scrollbar { display: none; }
        .filter-btn { background: #1e293b; color: #94a3b8; }
        .filter-btn.active { background: #1e40af; color: white; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="app-header p-3 flex justify-between items-center z-50">
        <div class="flex items-center gap-3" onclick="goHome()">
            <div class="bg-blue-700 w-10 h-10 rounded flex items-center justify-center text-white font-bold text-lg border border-blue-400">ML</div>
            <div>
                <h1 class="font-bold text-sm text-white leading-none tracking-widest">PROPART SYSTEM</h1>
                <p class="text-[9px] text-blue-400 font-bold tracking-wider">TALLER FERNANDO MILL√ÅN</p>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="toggleBluetooth()" id="bt-icon" class="text-gray-500 hover:text-white"><i class="fa-brands fa-bluetooth-b text-xl"></i></button>
            <button onclick="verCarrito()" class="relative text-white">
                <i class="fa-solid fa-cart-shopping text-xl"></i>
                <span id="badge-cart" class="absolute -top-2 -right-2 bg-red-600 text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">0</span>
            </button>
        </div>
    </div>

    <div id="main-container" class="flex-1 overflow-y-auto p-3 relative bg-[#050505]">

        <div id="view-home">
            <h2 class="text-gray-500 text-[10px] font-bold mb-4 uppercase tracking-[0.2em] border-b border-gray-800 pb-1">CENTRO DE MANDO</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="nav('scanner')" class="btn-main group">
                    <i class="fa-solid fa-laptop-code text-3xl text-blue-500 mb-2 group-active:scale-110 transition"></i>
                    <span class="text-[10px] font-bold text-white tracking-widest">SCANNER OBD2</span>
                </button>
                <button onclick="nav('inventory')" class="btn-main group">
                    <i class="fa-solid fa-boxes-stacked text-3xl text-green-500 mb-2 group-active:scale-110 transition"></i>
                    <span class="text-[10px] font-bold text-white tracking-widest">REFACCIONARIA</span>
                </button>
                <button onclick="nav('soft')" class="btn-main group">
                    <i class="fa-solid fa-book-open-reader text-3xl text-yellow-500 mb-2 group-active:scale-110 transition"></i>
                    <span class="text-[10px] font-bold text-white tracking-widest">DATOS T√âCNICOS</span>
                </button>
                <button onclick="loginAdmin()" class="btn-main group">
                    <i class="fa-solid fa-user-gear text-3xl text-red-500 mb-2 group-active:scale-110 transition"></i>
                    <span class="text-[10px] font-bold text-white tracking-widest">ADMINISTRAR</span>
                </button>
            </div>
            
            <div class="mt-6 border border-slate-800 bg-slate-900/50 p-4 rounded-lg">
                <h3 class="text-blue-400 font-bold text-xs mb-2">ESTADO DEL SISTEMA</h3>
                <div class="flex justify-between text-xs text-gray-400 font-mono">
                    <span>LICENCIA:</span> <span class="text-green-400">ACTIVA</span>
                </div>
                <div class="flex justify-between text-xs text-gray-400 font-mono mt-1">
                    <span>PROPIETARIO:</span> <span class="text-white">FERNANDO MILL√ÅN</span>
                </div>
                <div class="flex justify-between text-xs text-gray-400 font-mono mt-1">
                    <span>BASE DATOS:</span> <span>V40 PRODUCTION</span>
                </div>
            </div>
        </div>

        <div id="view-scanner" class="hidden">
            <div class="bg-slate-900 p-3 rounded border border-slate-700 mb-3 shadow-lg">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-white font-bold text-xs"><i class="fa-solid fa-link text-green-500"></i> INTERFAZ VCI</h2>
                    <span id="conn-status" class="text-[9px] bg-red-900 text-red-200 px-2 py-1 rounded">DESCONECTADO</span>
                </div>
                <button onclick="connectOBD()" id="btn-connect" class="w-full bg-blue-700 text-white py-3 rounded font-bold text-xs shadow hover:bg-blue-600 transition">
                    BUSCAR DISPOSITIVO BLUETOOTH (BLE)
                </button>
            </div>

            <div class="mb-3">
                <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-bold">
                    <span>FLUJO DE DATOS (LIVE)</span>
                    <span>PROTOCOL: ISO 15765-4 CAN</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-black border border-slate-800 p-3 rounded text-center">
                        <div class="text-[10px] text-gray-400">RPM MOTOR</div>
                        <div id="val-rpm" class="text-2xl font-bold text-green-400 font-mono">0</div>
                    </div>
                    <div class="bg-black border border-slate-800 p-3 rounded text-center">
                        <div class="text-[10px] text-gray-400">TEMP. REFRIG (ECT)</div>
                        <div id="val-temp" class="text-2xl font-bold text-red-400 font-mono">0 ¬∞C</div>
                    </div>
                    <div class="bg-black border border-slate-800 p-3 rounded text-center">
                        <div class="text-[10px] text-gray-400">VOLTAJE BATT</div>
                        <div id="val-volt" class="text-2xl font-bold text-yellow-400 font-mono">0.0 V</div>
                    </div>
                    <div class="bg-black border border-slate-800 p-3 rounded text-center">
                        <div class="text-[10px] text-gray-400">SENSOR O2 B1S1</div>
                        <div id="val-o2" class="text-2xl font-bold text-blue-400 font-mono">0.00 V</div>
                    </div>
                </div>
            </div>

            <div>
                <p class="text-[9px] text-gray-500 mb-1 font-bold">CONSOLA DE COMANDOS (HEX)</p>
                <div id="terminal" class="console">
                    <div class="text-gray-500">> ESPERANDO CONEXI√ìN...</div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="hidden">
            <div class="sticky top-0 bg-[#050505] z-10 pb-2">
                <input type="text" id="search-inv" placeholder="üîç BUSCAR PIEZA..." class="mb-2 border-blue-900 font-bold text-yellow-400" onkeyup="renderInv()">
                <div class="flex gap-2 overflow-x-auto no-scroll pb-1">
                    <button onclick="cambiarFiltro('TODO', this)" class="filter-btn active px-3 py-1 text-[10px] rounded border border-slate-700 whitespace-nowrap">TODO</button>
                    <button onclick="cambiarFiltro('BOBINAS', this)" class="filter-btn px-3 py-1 text-[10px] rounded border border-slate-700 whitespace-nowrap">BOBINAS</button>
                    <button onclick="cambiarFiltro('SENSORES', this)" class="filter-btn px-3 py-1 text-[10px] rounded border border-slate-700 whitespace-nowrap">SENSORES</button>
                    <button onclick="cambiarFiltro('ELECTRICO', this)" class="filter-btn px-3 py-1 text-[10px] rounded border border-slate-700 whitespace-nowrap">EL√âCTRICO</button>
                    <button onclick="cambiarFiltro('CARGA', this)" class="filter-btn px-3 py-1 text-[10px] rounded border border-slate-700 whitespace-nowrap">MARCHAS</button>
                </div>
            </div>
            
            <div id="inv-list" class="space-y-1 pb-20"></div>
            
            <div class="admin-view fixed bottom-20 right-4 z-30">
                <button onclick="modalAdd()" class="bg-green-600 w-14 h-14 rounded-full text-white shadow-2xl flex items-center justify-center text-2xl border-2 border-white"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <div id="view-soft" class="hidden">
            <div class="bg-slate-900 p-4 rounded border border-slate-700 mb-4 shadow-lg">
                <h2 class="text-blue-400 font-bold text-xs mb-3 border-b border-slate-700 pb-1">
                    <i class="fa-solid fa-database"></i> CONSULTA T√âCNICA
                </h2>
                <div class="space-y-2">
                    <select id="tech-make" onchange="loadModels()"><option value="">SELECCIONAR MARCA</option></select>
                    <select id="tech-model" onchange="loadEngines()"><option value="">MODELO</option></select>
                    <select id="tech-engine" onchange="showTechMenu()"><option value="">MOTOR</option></select>
                </div>
            </div>

            <div id="tech-menu" class="hidden grid grid-cols-2 gap-3 pb-20">
                <button onclick="showInfo('ECU')" class="bg-black border border-slate-700 p-4 rounded text-left hover:border-blue-500">
                    <i class="fa-solid fa-microchip text-blue-500 text-2xl mb-1 block"></i>
                    <div class="text-[10px] font-bold text-gray-300">ECU PINOUT</div>
                </button>
                <button onclick="showInfo('ENC')" class="bg-black border border-slate-700 p-4 rounded text-left hover:border-yellow-500">
                    <i class="fa-solid fa-bolt text-yellow-500 text-2xl mb-1 block"></i>
                    <div class="text-[10px] font-bold text-gray-300">BOBINAS</div>
                </button>
                <button onclick="showInfo('SENS')" class="bg-black border border-slate-700 p-4 rounded text-left hover:border-green-500">
                    <i class="fa-solid fa-wave-square text-green-500 text-2xl mb-1 block"></i>
                    <div class="text-[10px] font-bold text-gray-300">SENSORES</div>
                </button>
                <button onclick="showInfo('ELEC')" class="bg-black border border-slate-700 p-4 rounded text-left hover:border-red-500">
                    <i class="fa-solid fa-plug text-red-500 text-2xl mb-1 block"></i>
                    <div class="text-[10px] font-bold text-gray-300">EL√âCTRICO</div>
                </button>
            </div>
        </div>

    </div>

    <div class="fixed bottom-0 w-full bg-black h-16 border-t border-slate-800 flex items-stretch z-40">
        <button onclick="nav('home')" class="flex-1 text-gray-500 hover:text-white flex flex-col items-center justify-center gap-1 active:text-blue-500">
            <i class="fa-solid fa-house text-lg"></i> <span class="text-[9px] font-bold">INICIO</span>
        </button>
        <button onclick="nav('inventory')" class="flex-1 text-gray-500 hover:text-white flex flex-col items-center justify-center gap-1 active:text-blue-500">
            <i class="fa-solid fa-shop text-lg"></i> <span class="text-[9px] font-bold">VENTAS</span>
        </button>
    </div>

    <div id="modal-add" class="hidden fixed inset-0 bg-black/95 z-[60] flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-sm p-6 rounded border border-slate-700">
            <h3 class="text-white font-bold mb-4 text-center">NUEVO PRODUCTO</h3>
            <input type="text" id="add-nom" placeholder="NOMBRE" class="mb-2">
            <select id="add-cat" class="mb-2">
                <option value="BOBINAS">BOBINAS</option><option value="SENSORES">SENSORES</option>
                <option value="ELECTRICO">EL√âCTRICO</option><option value="CARGA">CARGA/ARRANQUE</option>
                <option value="FUEL">INYECCI√ìN</option><option value="BUJIAS">BUJ√çAS</option>
            </select>
            <input type="text" id="add-mod" placeholder="MODELO" class="mb-2">
            <input type="number" id="add-pre" placeholder="PRECIO" class="mb-2 text-green-500">
            <div class="flex gap-2">
                <button onclick="saveItem()" class="flex-1 bg-blue-600 text-white py-3 rounded font-bold text-xs">GUARDAR</button>
                <button onclick="cerrarModal('modal-add')" class="flex-1 bg-slate-700 text-white py-3 rounded font-bold text-xs">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-cart" class="hidden fixed inset-0 bg-black/95 z-[60] flex flex-col p-4">
        <div class="flex justify-between items-center border-b border-gray-800 pb-3 mb-3">
            <h2 class="text-white font-bold text-sm">NOTA DE VENTA - MILL√ÅN</h2>
            <button onclick="cerrarModal('modal-cart')" class="text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div id="cart-list" class="flex-1 overflow-y-auto space-y-2 mb-4 text-xs font-mono text-gray-300"></div>
        <div class="bg-slate-900 p-4 rounded border border-gray-800">
            <div class="flex justify-between text-white font-bold mb-4 text-lg"><span>TOTAL:</span><span id="cart-total" class="text-green-400">$0.00</span></div>
            <button onclick="enviarWhatsApp()" class="w-full bg-green-600 text-white py-3 rounded font-bold text-xs flex items-center justify-center gap-2">ENVIAR A WHATSAPP <i class="fa-brands fa-whatsapp text-lg"></i></button>
        </div>
    </div>

    <div id="modal-info" class="hidden fixed inset-0 bg-[#050505] z-[70] overflow-y-auto p-4">
        <div class="flex justify-between items-center border-b border-gray-800 pb-2 mb-4">
            <h3 id="info-title" class="text-blue-400 font-bold text-sm"></h3>
            <button onclick="cerrarModal('modal-info')" class="text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="info-content" class="space-y-4 text-xs font-mono text-gray-300"></div>
    </div>

    <script>
        const defaultDB = [
            {id:1, cat:"BOBINAS", nombre:"BOBINA JETTA A4 2.0L", modelo:"VW CUADRADA", precio:680},
            {id:2, cat:"BOBINAS", nombre:"BOBINA TSURU III", modelo:"NISSAN INTERNA", precio:450},
            {id:3, cat:"BOBINAS", nombre:"BOBINA CHEVY C2", modelo:"GM 3 PINES", precio:580},
            {id:4, cat:"BOBINAS", nombre:"BOBINA FORD FIESTA", modelo:"ZETEC", precio:650},
            {id:5, cat:"SENSORES", nombre:"SENSOR CKP JETTA G28", modelo:"VW A4", precio:480},
            {id:6, cat:"SENSORES", nombre:"SENSOR MAF TSURU", modelo:"HITACHI 3 PIN", precio:950},
            {id:7, cat:"SENSORES", nombre:"SENSOR O2 UNIVERSAL", modelo:"4 CABLES", precio:450},
            {id:8, cat:"CARGA", nombre:"PORTACARBON MARCHA", modelo:"VALEO CHEVY", precio:220},
            {id:9, cat:"CARGA", nombre:"BENDIX BOSCH 9D", modelo:"VW", precio:280},
            {id:10, cat:"ELECTRICO", nombre:"RELEVADOR 109", modelo:"VW ECU", precio:180}
        ];

        let appState = {
            inv: [],
            cart: [],
            isAdmin: false,
            currentFilter: 'TODO',
            btConnected: false,
            dataInterval: null
        };

        function saveDB() { 
            localStorage.setItem('ml_db_v40', JSON.stringify(appState.inv)); 
        }

        function loadDB() {
            const saved = localStorage.getItem('ml_db_v40');
            appState.inv = saved ? JSON.parse(saved) : [...defaultDB];
        }

        async function connectOBD() {
            const btn = document.getElementById('btn-connect');
            const status = document.getElementById('conn-status');

            if (appState.btConnected) {
                desconectarOBD();
                return;
            }

            if (!navigator.bluetooth) {
                alert("TU NAVEGADOR NO SOPORTA BLUETOOTH WEB. USA CHROME EN ANDROID.");
                simulateConnection();
                return;
            }

            try {
                logTerm("BUSCANDO DISPOSITIVOS BLE...");
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', 'e7810a71-73ae-499d-8c15-faa9aef0c3f2'] 
                });

                logTerm(`CONECTANDO A: ${device.name}...`);
                const server = await device.gatt.connect();
                
                status.innerText = "CONECTADO";
                status.className = "text-[9px] bg-green-900 text-green-200 px-2 py-1 rounded";
                btn.innerText = "DESCONECTAR";
                btn.className = "w-full bg-red-700 text-white py-3 rounded font-bold text-xs shadow hover:bg-red-600 transition";
                logTerm("CONEXI√ìN EXITOSA. PROTOCOLO ISO-15765-4");
                
                appState.btConnected = true;
                startDataStream();

            } catch (error) {
                logTerm("ERROR: " + error.message);
                logTerm("ACTIVANDO MODO SIMULACI√ìN...");
                setTimeout(simulateConnection, 1000);
            }
        }

        function desconectarOBD() {
            const status = document.getElementById('conn-status');
            const btn = document.getElementById('btn-connect');
            
            if (appState.dataInterval) {
                clearInterval(appState.dataInterval);
                appState.dataInterval = null;
            }
            
            appState.btConnected = false;
            status.innerText = "DESCONECTADO";
            status.className = "text-[9px] bg-red-900 text-red-200 px-2 py-1 rounded";
            btn.innerText = "BUSCAR DISPOSITIVO BLUETOOTH (BLE)";
            btn.className = "w-full bg-blue-700 text-white py-3 rounded font-bold text-xs shadow hover:bg-blue-600 transition";
            logTerm("DESCONECTADO");
            
            document.getElementById('val-rpm').innerText = '0';
            document.getElementById('val-temp').innerText = '0 ¬∞C';
            document.getElementById('val-volt').innerText = '0.0 V';
            document.getElementById('val-o2').innerText = '0.00 V';
        }

        function simulateConnection() {
            const status = document.getElementById('conn-status');
            const btn = document.getElementById('btn-connect');
            
            setTimeout(() => logTerm("TX: ATZ (RESET)"), 500);
            setTimeout(() => logTerm("RX: ELM327 v1.5"), 1000);
            setTimeout(() => logTerm("TX: 0100 (SEARCH)"), 1500);
            setTimeout(() => {
                logTerm("CONEXI√ìN ESTABLECIDA (SIM)");
                status.innerText = "ONLINE (SIM)";
                status.className = "text-[9px] bg-green-900 text-green-200 px-2 py-1 rounded";
                btn.innerText = "DESCONECTAR";
                btn.className = "w-full bg-red-700 text-white py-3 rounded font-bold text-xs shadow hover:bg-red-600 transition";
                appState.btConnected = true;
                startDataStream();
            }, 2500);
        }

        function startDataStream() {
            appState.dataInterval = setInterval(() => {
                document.getElementById('val-rpm').innerText = Math.floor(Math.random() * 50 + 800);
                document.getElementById('val-temp').innerText = Math.floor(Math.random() * 6 + 92) + " ¬∞C";
                document.getElementById('val-volt').innerText = (Math.random() * 0.4 + 13.8).toFixed(1) + " V";
                document.getElementById('val-o2').innerText = (Math.random() * 0.7 + 0.1).toFixed(2) + " V";
            }, 800);
        }

        function logTerm(msg) {
            const t = document.getElementById('terminal');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            t.appendChild(d);
            t.scrollTop = t.scrollHeight;
        }

        function toggleBluetooth() {
            const icon = document.getElementById('bt-icon');
            if (appState.btConnected) {
                icon.className = "text-blue-500";
            } else {
                icon.className = "text-gray-500 hover:text-white";
            }
        }

        function renderInv() {
            const list = document.getElementById('inv-list');
            const term = document.getElementById('search-inv').value.toUpperCase();
            list.innerHTML = '';

            const filtered = appState.inv.filter(p => 
                (appState.currentFilter === 'TODO' || p.cat === appState.currentFilter) &&
                (p.nombre.includes(term) || p.modelo.includes(term))
            );

            filtered.forEach(p => {
                let adm = appState.isAdmin ? `<button onclick="delItem(${p.id})" class="text-red-500 ml-2"><i class="fa-solid fa-trash"></i></button>` : '';
                list.innerHTML += `
                <div class="card">
                    <div class="flex justify-between">
                        <div>
                            <div class="text-[10px] text-gray-500 font-bold">${p.cat}</div>
                            <div class="font-bold text-xs text-white">${p.nombre}</div>
                            <div class="text-[9px] text-gray-400 font-mono">${p.modelo}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-green-400 font-bold text-sm mb-1">$${p.precio}</div>
                            <button onclick="addCart(${p.id})" class="bg-blue-700 text-white px-3 py-1 rounded text-[10px] font-bold">AGREGAR</button>
                            ${adm}
                        </div>
                    </div>
                </div>`;
            });
        }

        function cambiarFiltro(cat, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            appState.currentFilter = cat;
            renderInv();
        }

        function addCart(id) {
            const item = appState.inv.find(x => x.id === id);
            if (item) {
                appState.cart.push(item);
                document.getElementById('badge-cart').innerText = appState.cart.length;
            }
        }

        function verCarrito() {
            const l = document.getElementById('cart-list');
            l.innerHTML = '';
            let total = 0;
            
            appState.cart.forEach((p, i) => {
                total += parseInt(p.precio);
                l.innerHTML += `<div class="flex justify-between border-b border-gray-800 py-2"><span>${p.nombre}</span><span>$${p.precio}</span></div>`;
            });
            
            document.getElementById('cart-total').innerText = '$' + total.toFixed(2);
            document.getElementById('modal-cart').classList.remove('hidden');
        }

        function enviarWhatsApp() {
            if(appState.cart.length === 0) {
                alert("CARRITO VAC√çO");
                return;
            }
            
            let msg = "*ORDEN DE VENTA - PROPART SYSTEM ML*\n---------------------------\n";
            let total = 0;
            
            appState.cart.forEach(p => { 
                msg += `‚ñ™ ${p.nombre} .. $${p.precio}\n`; 
                total += parseInt(p.precio); 
            });
            
            msg += 
