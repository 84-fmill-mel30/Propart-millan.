<script>
// --- VARIABLES GLOBALES DE CONEXIÓN ---
let port;
let reader;
let writer;

// --- FUNCIÓN PRINCIPAL DE SINCRONIZACIÓN BLUETOOTH ---
async function syncDevice() {
    const statusLed = document.getElementById('led');
    const statusText = document.getElementById('status-text');

    try {
        // Solicitud de puerto serial (Bluetooth/USB)
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });

        statusLed.style.backgroundColor = '#00ff00'; // LED Verde
        statusLed.style.boxShadow = '0 0 15px #00ff00';
        statusText.innerText = "Sincronizado: Dispositivo OBD-II Conectado";
        
        console.log("Conexión Propart establecida con éxito.");
        readData(); // Inicia la escucha de datos
    } catch (error) {
        console.error("Error de conexión:", error);
        statusLed.style.backgroundColor = '#ff0000'; // LED Rojo
        statusText.innerText = "Error: No se pudo sincronizar";
    }
}

// --- LÓGICA DE DIAGNÓSTICO Y OPERACIONES PREMIUM ---
const PropartPremium = {
    // Lectura de Inmovilizador vía Canal 25
    readImmoChannel: async function() {
        console.log("Iniciando lectura en Canal 25...");
        // Comando OBD para entrar a Inmo (Referencia KWP2000/UDS)
        this.sendCommand("01 25"); 
    },

    // Procedimiento Immo Off (Arquitectura de desbloqueo)
    executeImmoOff: function() {
        if(confirm("¿Confirmas la modificación de la EEPROM para IMMO OFF?")) {
            console.log("Ejecutando bypass de seguridad...");
            this.sendCommand("WRITE_EEPROM_IMMO_DISABLE");
        }
    },

    // Envío de comandos al puerto serial
    sendCommand: async function(command) {
        if (port && port.writable) {
            const encoder = new TextEncoder();
            const writer = port.writable.getWriter();
            await writer.write(encoder.encode(command + "\r"));
            writer.releaseLock();
        } else {
            alert("Socio, primero dale a SINCRONIZAR para conectar el equipo.");
        }
    }
};

// --- ESCUCHA DE DATOS ENTRANTES (DATA STREAM) ---
async function readData() {
    while (port.readable) {
        const reader = port.readable.getReader();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                // Aquí procesamos la respuesta del auto (Hexadecimal)
                let response = new TextDecoder().decode(value);
                console.log("Datos recibidos:", response);
                
                // Si detectamos el PIN del inmovilizador en la trama
                if(response.includes("7F 25")) {
                    document.getElementById('display-data').innerText = "Pin Code Localizado: ****";
                }
            }
        } catch (error) {
            console.error("Error leyendo datos:", error);
        } finally {
            reader.releaseLock();
        }
    }
}

// --- VINCULACIÓN CON LOS BOTONES DEL DASHBOARD ---
document.addEventListener('DOMContentLoaded', () => {
    // Botón Sincronizar
    const syncBtn = document.querySelector('.btn-sync');
    if(syncBtn) syncBtn.addEventListener('click', syncDevice);

    // Botones de Operaciones Premium
    const btnCanal25 = document.querySelector('button:contains("Canal 25")');
    if(btnCanal25) btnCanal25.addEventListener('click', () => PropartPremium.readImmoChannel());
});
</script>
